<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: head}">
    <title>Dashboard - PocketBook</title>
</head>
<body>
  <!--CSS-->
  <link rel="stylesheet" th:href="@{/css/dashboard/dashboard.css}" href="/css/dashboard/dashboard.css">
  
  <!-- NAVBAR -->
  <nav th:replace="~{fragments/navbar :: navbar}"></nav>

  <!-- CONTENEDOR PRINCIPAL CON SIDEBAR Y CONTENIDO -->
  <div class="container-fluid">
    <div class="row">
      <!-- SIDEBAR -->
      <aside th:replace="~{fragments/sidebar :: sidebar}"></aside>

      <!-- CONTENIDO PRINCIPAL -->
      <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-3 mb-4 border-bottom">
          <div>
            <h1 class="h2 fw-bold mb-1">
              <i class="bi bi-grid text-primary me-2"></i>
              Dashboard
            </h1>
            <p class="text-muted mb-0" th:if="${usuario != null}">
              Bienvenido de nuevo, <span class="fw-semibold" th:text="${usuario.nombre}">Usuario</span>
            </p>
          </div>
          <div class="text-muted small" th:if="${usuario != null}">
            <i class="bi bi-calendar3 me-1"></i>
            Miembro desde <span th:text="${#temporals.format(usuario.fechaRegistro, 'dd/MM/yyyy')}">01/01/2024</span>
          </div>
        </div>

        <!-- CARDS DE RESUMEN -->
        <div class="row g-4 mb-4">
          <div class="col-md-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <h6 class="text-muted mb-2">Gastos del Mes</h6>
                    <h3 class="fw-bold mb-0" th:text="${'$' + #numbers.formatDecimal(totalGastosMes, 0, 'COMMA', 0, 'POINT') + ' CLP'}">$0 CLP</h3>
                  </div>
                  <div class="icon-box bg-danger bg-opacity-10 rounded-circle p-3">
                    <i class="bi bi-cash-stack text-danger fs-4"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <h6 class="text-muted mb-2">Ingresos del Mes</h6>
                    <h3 class="fw-bold mb-0 text-success" th:text="${'$' + #numbers.formatDecimal(totalIngresosMes, 0, 'COMMA', 0, 'POINT') + ' CLP'}">$0 CLP</h3>
                  </div>
                  <div class="icon-box bg-success bg-opacity-10 rounded-circle p-3">
                    <i class="bi bi-wallet2 text-success fs-4"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <h6 class="text-muted mb-2">Ahorro (Ingresos - Gastos)</h6>
                    <h3 class="fw-bold mb-0" 
                        th:class="${ahorro >= 0} ? 'fw-bold mb-0 text-success' : 'fw-bold mb-0 text-danger'"
                        th:text="${'$' + #numbers.formatDecimal(ahorro, 0, 'COMMA', 0, 'POINT') + ' CLP'}">$0 CLP</h3>
                  </div>
                  <div class="icon-box bg-info bg-opacity-10 rounded-circle p-3">
                    <i class="bi bi-piggy-bank text-info fs-4"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-md-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <h6 class="text-muted mb-2">Transacciones (Gastos)</h6>
                    <h3 class="fw-bold mb-0" th:text="${totalTransacciones}">0</h3>
                  </div>
                  <div class="icon-box bg-warning bg-opacity-10 rounded-circle p-3">
                    <i class="bi bi-list-ul text-warning fs-4"></i>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- SECCIÓN DE ACTIVIDAD RECIENTE -->
        <div class="row g-4">
          <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
              <div class="card-header bg-white border-0 py-3">
                <h5 class="mb-0 fw-bold">
                  <i class="bi bi-clock-history text-primary me-2"></i>
                  Actividad Reciente (Últimas 7 Transacciones)
                </h5>
              </div>
              <div class="card-body">
                <div th:if="${!hayActividad}" class="text-center py-5 text-muted">
                  <i class="bi bi-inbox fs-1 mb-3 d-block"></i>
                  <p>No hay transacciones recientes</p>
                </div>
                
                <div th:if="${hayActividad}" class="list-group list-group-flush">
                  <div th:each="actividad : ${actividadReciente}" 
                       class="list-group-item border-0 px-0 py-3 d-flex justify-content-between align-items-center">
                    
                    <!-- SI ES GASTO -->
                    <div th:if="${actividad.tipo == 'GASTO'}" class="d-flex align-items-center w-100">
                      <div class="d-flex align-items-center flex-grow-1">
                        <div class="icon-circle bg-danger bg-opacity-10 rounded-circle p-2 me-3">
                          <i class="bi bi-arrow-down-circle text-danger"></i>
                        </div>
                        <div>
                          <h6 class="mb-0 fw-semibold">
                            <span class="badge bg-danger bg-opacity-10 text-danger me-2">GASTO</span>
                            <span th:text="${actividad.descripcion}">Descripción</span>
                          </h6>
                          <small class="text-muted">
                            <i class="bi bi-tag me-1"></i>
                            <span th:text="${actividad.categoria}">Categoría</span>
                            <span class="mx-2">•</span>
                            <i class="bi bi-calendar3 me-1"></i>
                            <span th:text="${#temporals.format(actividad.fecha, 'dd/MM/yyyy')}">Fecha</span>
                            <span class="mx-2">•</span>
                            <i class="bi bi-credit-card me-1"></i>
                            <span th:text="${actividad.metodoPago}">Método</span>
                          </small>
                        </div>
                      </div>
                      <div class="text-end ms-3">
                        <span class="fw-bold text-danger" 
                              th:text="${'-$' + #numbers.formatDecimal(actividad.monto, 0, 'POINT', 2, 'COMMA')}">-$0.00</span>
                        <br>
                        <span th:if="${actividad.numeroCuotas != null and actividad.numeroCuotas > 1}" 
                              class="badge bg-info bg-opacity-10 text-info">
                          <i class="bi bi-cash-coin me-1"></i>
                          Cuota <span th:text="${actividad.cuotaActual}">1</span>/<span th:text="${actividad.numeroCuotas}">1</span>
                        </span>
                      </div>
                    </div>
                    
                    <!-- SI ES INGRESO -->
                    <div th:if="${actividad.tipo == 'INGRESO'}" class="d-flex align-items-center w-100">
                      <div class="d-flex align-items-center flex-grow-1">
                        <div class="icon-circle bg-success bg-opacity-10 rounded-circle p-2 me-3">
                          <i class="bi bi-arrow-up-circle text-success"></i>
                        </div>
                        <div>
                          <h6 class="mb-0 fw-semibold">
                            <span class="badge bg-success bg-opacity-10 text-success me-2">INGRESO</span>
                            <span th:text="${actividad.descripcion}">Descripción</span>
                          </h6>
                          <small class="text-muted">
                            <i class="bi bi-tag me-1"></i>
                            <span th:text="${actividad.tipoIngreso}">Tipo</span>
                            <span class="mx-2">•</span>
                            <i class="bi bi-calendar3 me-1"></i>
                            <span th:text="${#temporals.format(actividad.fecha, 'dd/MM/yyyy')}">Fecha</span>
                            <span class="mx-2" th:if="${actividad.origen != null and !#strings.isEmpty(actividad.origen)}">•</span>
                            <i class="bi bi-building me-1" th:if="${actividad.origen != null and !#strings.isEmpty(actividad.origen)}"></i>
                            <span th:if="${actividad.origen != null and !#strings.isEmpty(actividad.origen)}" th:text="${actividad.origen}">Origen</span>
                          </small>
                        </div>
                      </div>
                      <div class="text-end ms-3">
                        <span class="fw-bold text-success" 
                              th:text="${'+$' + #numbers.formatDecimal(actividad.monto, 0, 'POINT', 2, 'COMMA')}">+$0.00</span>
                        <br>
                        <span class="badge bg-success bg-opacity-10 text-success" th:text="${actividad.categoria}">Categoría</span>
                      </div>
                    </div>
                    
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-4">
            <div class="card border-0 shadow-sm">
              <div class="card-header bg-white border-0 py-3">
                <h5 class="mb-0 fw-bold">
                  <i class="bi bi-pie-chart text-primary me-2"></i>
                  Top 5 Categorías del Mes
                </h5>
              </div>
              <div class="card-body">
                <div th:if="${!hayCategorias}" class="text-center py-5 text-muted">
                  <i class="bi bi-tags fs-1 mb-3 d-block"></i>
                  <p>Sin gastos en categorías este mes</p>
                </div>
                
                <div th:if="${hayCategorias}">
                  <div th:each="categoria, iterStat : ${categoriasTop}" class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <span class="fw-semibold">
                        <span class="badge bg-primary me-2" th:text="${iterStat.count}">1</span>
                        <span th:text="${categoria.key}">Categoría</span>
                      </span>
                      <span class="text-danger fw-bold" 
                            th:text="${'$' + #numbers.formatDecimal(categoria.value, 0, 'POINT', 2, 'COMMA')}">$0.00</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                      <div class="progress-bar bg-primary" 
                           role="progressbar" 
                           th:style="'width: ' + ${categoria.value / categoriasTop[0].value * 100} + '%'"
                           th:attr="aria-valuenow=${categoria.value}, aria-valuemin=0, aria-valuemax=${categoriasTop[0].value}">
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- SCRIPTS -->
  <div th:replace="~{fragments/scripts :: scripts}"></div>
</body>
</html>