<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/head :: head}">
    <title>Configuración - PocketBook</title>
</head>
<body>
    <!--CSS-->
    <link rel="stylesheet" th:href="@{/css/common/navbar.css}" href="/css/common/navbar.css">
    <link rel="stylesheet" th:href="@{/css/dashboard/dashboard.css}" href="/css/dashboard/dashboard.css">
    
    <!-- NAVBAR -->
    <script th:src="@{/js/configuracion/configuracion.js}" src="/js/configuracion/configuracion.js"></script>
        const response = await fetch('/api/notificaciones/configuracion', {
          method: 'GET',
          headers: headers
        });
        
        if (response.ok) {
          const config = await response.json();
          document.getElementById('notif-email').checked = config.notificacionesEmail;
          document.getElementById('notif-transacciones').checked = config.alertasTransacciones;
          document.getElementById('notif-presupuesto').checked = config.alertasPresupuesto;
          document.getElementById('notif-reportes').checked = config.reportesMensuales;
          document.getElementById('notif-promociones').checked = config.promociones;
        }
      } catch (error) {
        console.error('Error al cargar configuración de notificaciones:', error);
      }
    }
    
    // Cargar al iniciar la página
    cargarConfiguracionNotificaciones();
    
    // Guardar apariencia
    document.getElementById('btnGuardarApariencia').addEventListener('click', async function() {
      const idioma = document.getElementById('language').value;
      const moneda = document.getElementById('currency').value;
      
      const btn = this;
      const textOriginal = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Guardando...';
      
      try {
        const headers = {
          'Content-Type': 'application/json'
        };
        if (csrfToken && csrfHeader) {
          headers[csrfHeader] = csrfToken;
        }
        
        const response = await fetch('/configuracion/apariencia', {
          method: 'POST',
          headers: headers,
          body: JSON.stringify({tema: 'light', idioma, moneda})
        });
        
        const data = await response.json();
        
        if (data.success) {
          btn.innerHTML = '<i class="bi bi-check-circle me-2"></i>¡Guardado!';
          btn.classList.remove('btn-primary');
          btn.classList.add('btn-success');
          setTimeout(() => {
            btn.innerHTML = textOriginal;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-primary');
            btn.disabled = false;
          }, 1500);
        } else {
          throw new Error(data.message);
        }
      } catch (error) {
        console.error('Error al guardar apariencia:', error);
        btn.innerHTML = '<i class="bi bi-x-circle me-2"></i>Error';
        btn.classList.add('btn-danger');
        setTimeout(() => {
          btn.innerHTML = textOriginal;
          btn.classList.remove('btn-danger');
          btn.disabled = false;
        }, 1500);
      }
    });
    
    // Guardar notificaciones
    document.getElementById('btnGuardarNotificaciones').addEventListener('click', async function() {
      const btn = this;
      const textOriginal = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Guardando...';
      
      try {
        const headers = {
          'Content-Type': 'application/json'
        };
        if (csrfToken && csrfHeader) {
          headers[csrfHeader] = csrfToken;
        }
        
        const response = await fetch('/api/notificaciones/configuracion', {
          method: 'POST',
          headers: headers,
          body: JSON.stringify({
            notificacionesEmail: document.getElementById('notif-email').checked,
            alertasTransacciones: document.getElementById('notif-transacciones').checked,
            alertasPresupuesto: document.getElementById('notif-presupuesto').checked,
            reportesMensuales: document.getElementById('notif-reportes').checked,
            promociones: document.getElementById('notif-promociones').checked
          })
        });
        
        if (response.ok) {
          btn.innerHTML = '<i class="bi bi-check-circle me-2"></i>¡Guardado!';
          btn.classList.remove('btn-primary');
          btn.classList.add('btn-success');
          setTimeout(() => {
            btn.innerHTML = textOriginal;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-primary');
            btn.disabled = false;
          }, 1500);
        } else {
          throw new Error('Error al guardar');
        }
      } catch (error) {
        console.error('Error al guardar notificaciones:', error);
        btn.innerHTML = '<i class="bi bi-x-circle me-2"></i>Error';
        btn.classList.add('btn-danger');
        setTimeout(() => {
          btn.innerHTML = textOriginal;
          btn.classList.remove('btn-danger');
          btn.disabled = false;
        }, 1500);
      }
    });
    
    // Toggle 2FA
    document.getElementById('btn2FA').addEventListener('click', async function() {
      const btn = this;
      const estaActivado = btn.classList.contains('btn-success');
      btn.disabled = true;
      
      try {
        const headers = {
          'Content-Type': 'application/json'
        };
        if (csrfToken && csrfHeader) {
          headers[csrfHeader] = csrfToken;
        }
        
        const response = await fetch('/configuracion/autenticacion-dos-factores', {
          method: 'POST',
          headers: headers,
          body: JSON.stringify({activar: !estaActivado})
        });
        
        const data = await response.json();
        
        if (data.success) {
          const icon = btn.querySelector('i');
          const span = btn.querySelector('span');
          
          if (data.activado) {
            btn.classList.remove('btn-outline-secondary');
            btn.classList.add('btn-success');
            icon.classList.remove('bi-toggle-off');
            icon.classList.add('bi-toggle-on');
            span.textContent = 'Activado';
          } else {
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-secondary');
            icon.classList.remove('bi-toggle-on');
            icon.classList.add('bi-toggle-off');
            span.textContent = 'Desactivado';
          }
        }
        btn.disabled = false;
      } catch (error) {
        console.error('Error al actualizar 2FA:', error);
        alert('Error al actualizar la autenticación de dos factores');
        btn.disabled = false;
      }
    });
    
    // Archivar datos antiguos
    document.getElementById('btnArchivarDatos').addEventListener('click', async function() {
      if (!confirm('¿Estás seguro de que deseas archivar los datos antiguos? Esta acción no se puede deshacer.')) {
        return;
      }
      
      const btn = this;
      const textOriginal = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Archivando...';
      
      try {
        const headers = {
          'Content-Type': 'application/json'
        };
        if (csrfToken && csrfHeader) {
          headers[csrfHeader] = csrfToken;
        }
        
        const response = await fetch('/configuracion/archivar-datos', {
          method: 'POST',
          headers: headers
        });
        
        const data = await response.json();
        
        if (data.success) {
          btn.innerHTML = '<i class="bi bi-check-circle me-2"></i>¡Archivado!';
          btn.classList.add('btn-success');
          setTimeout(() => {
            btn.innerHTML = textOriginal;
            btn.classList.remove('btn-success');
            btn.disabled = false;
          }, 2000);
        } else {
          throw new Error(data.message);
        }
      } catch (error) {
        console.error('Error al archivar datos:', error);
        btn.innerHTML = '<i class="bi bi-x-circle me-2"></i>Error';
        btn.classList.add('btn-danger');
        setTimeout(() => {
          btn.innerHTML = textOriginal;
          btn.classList.remove('btn-danger');
          btn.disabled = false;
        }, 2000);
      }
    });
  </script>
</body>
</html>
